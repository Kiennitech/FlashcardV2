<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flashcard TOEIC - L·∫∑p l·∫°i ng·∫Øt qu√£ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; overflow-x: hidden; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            padding-top: 1rem; 
            padding-bottom: 1rem;
            /* S·ª¨A L·ªñI IOS: NgƒÉn ch·∫∑n double-tap-to-zoom m·ªôt c√°ch hi·ªáu qu·∫£ */
            touch-action: manipulation;
        }
        body.modal-open { overflow: hidden; }
        button, .animated-button, .srs-icon-btn, .card-nav-btn { -webkit-tap-highlight-color: transparent; }
        .flashcard-container { perspective: 1200px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1); cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(-180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1); padding: 1.5rem; border: 1px solid rgba(0,0,0,0.05); }
        .flashcard-front { background-color: white; color: #111827; }
        .flashcard-back { 
            background-color: #f8fafc; 
            color: #0f172a; 
            transform: rotateY(-180deg); 
            overflow-y: auto; 
            justify-content: flex-start;
            /* S·ª¨A L·ªñI IOS: B·∫≠t ch·∫ø ƒë·ªô cu·ªôn m∆∞·ª£t m√† (momentum scrolling) */
            -webkit-overflow-scrolling: touch;
        }
        .animated-button { 
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1); 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            /* S·ª¨A L·ªñI IOS: B√°o cho tr√¨nh duy·ªát bi·∫øt thu·ªôc t√≠nh n√†y s·∫Ω thay ƒë·ªïi ƒë·ªÉ t·ªëi ∆∞u h√≥a */
            will-change: transform;
        }
        .animated-button:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .animated-button:active { transform: translateY(0px) scale(0.98); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .animated-button:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .play-audio-btn { background: none; border: none; padding: 6px; cursor: pointer; transition: all 0.2s; display: inline-flex; vertical-align: middle; color: #0f172a; }
        .play-audio-btn:hover { transform: scale(1.1); color: #0ea5e9; }
        .play-audio-btn.playing, .play-audio-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .play-audio-btn.playing svg { color: #0ea5e9; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        .modal.hidden { display: none; }
        .progress-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(16px, 1fr)); gap: 4px; }
        .progress-dot { cursor: pointer; transition: transform 0.1s ease-in-out; }
        .progress-dot:hover { transform: scale(1.5); }
        #toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2d3748; color: white; padding: 12px 24px; border-radius: 8px; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, transform 0.3s; }
        #toast-notification.show { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }
        .card-nav-btn { position: absolute; bottom: 1rem; width: 4.5rem; height: 4.5rem; background-color: transparent; color: #d1d5db; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: color 0.2s ease-in-out; pointer-events: auto; border-radius: 50%; }
        .card-nav-btn svg { width: 20px; height: 20px; }
        .card-nav-btn:hover { color: #9ca3af; }
        .card-nav-btn.hidden { opacity: 0 !important; pointer-events: none !important; }
        #card-counter.visible { opacity: 1; }
        .srs-icon-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 0.5rem; transition: background-color 0.2s, transform 0.1s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; flex: 1; }
        .srs-icon-btn:hover { background-color: #f1f5f9; }
        .srs-icon-btn:focus-visible { outline: none; box-shadow: none; }
        .srs-icon-btn:active { transform: scale(0.95); }
        .topic-modal-item {
            transition: background-color 0.2s, color 0.2s;
        }
        #topic-list-container {
            /* S·ª¨A L·ªñI IOS: B·∫≠t ch·∫ø ƒë·ªô cu·ªôn m∆∞·ª£t m√† (momentum scrolling) */
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="flex flex-col items-center">

    <div class="w-full max-w-3xl mx-auto flex flex-col flex-grow">
        <main class="flex-grow">
            <div class="flashcard-container w-full h-[36rem] md:h-[45rem] mb-6 relative mt-4">
                <div id="flashcard" class="flashcard">
                    <div class="flashcard-face flashcard-front">
                        <div id="card-front-content" class="text-center p-4">
                            <p class="text-xl text-slate-500">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ v·ª±ng...</p>
                        </div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div id="card-back-content" class="text-left w-full h-full"></div>
                    </div>
                </div>
                <div id="card-counter" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black bg-opacity-50 text-white text-sm font-semibold px-3 py-1 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none">0 / 0</div>
                <button id="card-prev-btn" class="card-nav-btn left-2 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
                </button>
                <button id="card-next-btn" class="card-nav-btn right-2 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
            
            <div id="srs-controls" class="flex flex-col items-center justify-center w-full my-8 space-y-4">
                <div id="srs-rating-group" class="w-full items-center justify-around space-x-2 flex bg-white p-2 rounded-2xl shadow-sm invisible opacity-0 transition-opacity duration-300 ease-in-out">
                   <button data-rating="hard" class="srs-icon-btn srs-rating-btn">
                       <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M16 16s-1.5-2-4-2-4 2-4 2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                       <span class="text-sm font-medium text-red-500">Kh√≥</span>
                   </button>
                   <button data-rating="good" class="srs-icon-btn srs-rating-btn">
                       <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="15" x2="16" y2="15"></line><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                       <span class="text-sm font-medium text-blue-500">Trung b√¨nh</span>
                   </button>
                   <button data-rating="easy" class="srs-icon-btn srs-rating-btn">
                       <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                       <span class="text-sm font-medium text-green-600">D·ªÖ</span>
                   </button>
                   <button id="known-btn" class="srs-icon-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>
                       <span class="text-sm font-medium text-purple-500 text-center">ƒê√£ bi·∫øt</span>
                   </button>
                </div>

                <div id="action-buttons-group" class="flex items-center justify-center gap-3">
                    <button id="back-to-learn-btn" class="hidden animated-button p-4 bg-white text-slate-600 rounded-xl" title="Quay l·∫°i h·ªçc">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    </button>
                    <button id="shuffle-btn" class="hidden animated-button p-4 bg-white text-slate-600 rounded-xl" title="X√°o tr·ªôn danh s√°ch t·ª´">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
                    </button>
                     <button id="topic-progress-btn" class="hidden animated-button p-4 bg-white text-slate-600 rounded-xl" title="Th·ªëng k√™ theo ch·ªß ƒë·ªÅ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pie-chart"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                    </button>
                    <button id="progress-matrix-btn" class="animated-button p-4 bg-white text-slate-600 rounded-xl" title="Th·ªëng k√™ t·ªïng qu√°t">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                    </button>
                </div>
            </div>
        </main>
        
        <footer class="w-full pt-4 pb-4">
            <div class="w-full max-w-xl mx-auto flex flex-col gap-3">
                <div class="flex items-center gap-3">
                    <button id="topic-review-btn" class="hidden animated-button flex-1 px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg flex flex-col items-center justify-center disabled:bg-slate-300 disabled:transform-none disabled:shadow-none text-sm" title="√în t·∫≠p c√°c t·ª´ ƒë√£ h·ªçc trong ch·ªß ƒë·ªÅ n√†y">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <span>√în t·∫≠p theo ch·ªß ƒë·ªÅ</span>
                        </div>
                        <span class="text-xs font-normal opacity-80">(<span class="font-bold">0</span>)</span>
                    </button>
                    <button id="srs-review-btn" class="animated-button flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg flex flex-col items-center justify-center disabled:bg-slate-300 disabled:transform-none disabled:shadow-none text-sm" title="√în t·∫≠p c√°c t·ª´ ƒë√£ h·ªçc theo ph∆∞∆°ng ph√°p l·∫∑p l·∫°i ng·∫Øt qu√£ng">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                            <span>Luy·ªán t·∫≠p ng√†y</span>
                        </div>
                        <span class="text-xs font-normal opacity-80">(<span class="font-bold">0</span>)</span>
                    </button>
                </div>
                <!-- N√¢ng c·∫•p: Thay th·∫ø dropdown b·∫±ng button -->
                <div class="relative w-full">
                    <button id="open-topic-modal-btn" class="w-full p-2.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer flex justify-between items-center text-left">
                        <span id="current-topic-display">Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ...</span>
                        <svg class="fill-current h-4 w-4 text-slate-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </button>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- N√¢ng c·∫•p: Th√™m Modal ch·ªçn ch·ªß ƒë·ªÅ -->
    <div id="topic-select-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-lg w-full max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800">Ch·ªçn ch·ªß ƒë·ªÅ</h3>
                <button id="close-topic-modal-btn" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="relative mb-4">
                <input type="search" id="topic-search-input" placeholder="T√¨m ki·∫øm ch·ªß ƒë·ªÅ..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <div id="topic-list-container" class="overflow-y-auto -mr-2 pr-2 space-y-2">
                <!-- Danh s√°ch ch·ªß ƒë·ªÅ s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
            </div>
        </div>
    </div>

    <div id="error-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="error-title" class="text-lg font-bold text-red-600 mb-2">ƒê√£ x·∫£y ra l·ªói</h3>
            <p id="error-message" class="text-slate-600 mb-4">Kh√¥ng th·ªÉ th·ª±c hi·ªán y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i.</p>
            <button id="close-error-modal-btn" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">ƒê√≥ng</button>
        </div>
    </div>

    <div id="progress-matrix-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-4xl w-full max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="progress-modal-title" class="text-xl font-bold text-slate-800">Th·ªëng k√™ t·ªïng qu√°t</h3>
                <button id="close-progress-matrix-btn" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="progress-stats" class="grid grid-cols-2 md:grid-cols-5 items-center justify-center gap-4 text-xs mb-4">
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-slate-300"></div><span>Ch∆∞a h·ªçc (<span id="stats-unstudied-count">0</span> - <span id="stats-unstudied-percent">0%</span>)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-red-500"></div><span>Kh√≥ (<span id="stats-hard-count">0</span> - <span id="stats-hard-percent">0%</span>)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-blue-500"></div><span>Trung b√¨nh (<span id="stats-good-count">0</span> - <span id="stats-good-percent">0%</span>)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-green-500"></div><span>D·ªÖ (<span id="stats-easy-count">0</span> - <span id="stats-easy-percent">0%</span>)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-purple-500"></div><span>ƒê√£ bi·∫øt (<span id="stats-known-count">0</span> - <span id="stats-known-percent">0%</span>)</span></div>
            </div>
            <div id="progress-grid-container" class="progress-grid overflow-y-auto p-2 bg-slate-100 rounded-lg">
            </div>
            <div class="mt-4 pt-4 border-t border-slate-200">
                <button id="reset-progress-btn" class="w-full bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 transition-colors">X√≥a to√†n b·ªô ti·∫øn tr√¨nh h·ªçc t·∫≠p</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="confirm-title" class="text-lg font-bold text-slate-800 mb-2">X√°c nh·∫≠n</h3>
            <p id="confirm-message" class="text-slate-600 mb-4">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y kh√¥ng?</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">H·ªßy</button>
                <button id="confirm-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <div id="toast-notification"></div>

    <script>
        // --- CONSTANTS AND STATE VARIABLES ---
        const SRS_PROGRESS_KEY = "toeicSrsProgressData";
        const LAST_SESSION_KEY = "toeicLastSession";
        
        const MODES = { LEARN: 'learn', TOPIC_REVIEW: 'topic_review', GLOBAL_REVIEW: 'global_review' };
        let currentMode = MODES.LEARN;

        let vocabularyList = [];
        let vocabularyMap = new Map();
        let categories = {};

        let srsProgressData = {};
        const SRS_INTERVALS = { 1: 1, 2: 3, 3: 7, 4: 14, 5: 30, 6: 90 };
        const MAX_SRS_LEVEL = Object.keys(SRS_INTERVALS).length;

        let currentCategoryKey = '';
        let currentWords = [];
        let currentIndex = 0;
        
        let speechSynth = window.speechSynthesis;
        let availableVoices = [];
        let voicesLoaded = false;
        let counterTimeout = null;
        let lastProgressViewCategory = null; 
        let userHasInteracted = false;

        const ui = {
            flashcard: document.getElementById('flashcard'),
            flashcardFront: document.querySelector('.flashcard-face.flashcard-front'),
            cardBackContent: document.getElementById('card-back-content'),
            srsControls: document.getElementById('srs-controls'),
            srsRatingGroup: document.getElementById('srs-rating-group'),
            cardCounter: document.getElementById('card-counter'),
            cardPrevBtn: document.getElementById('card-prev-btn'),
            cardNextBtn: document.getElementById('card-next-btn'),
            srsReviewBtn: document.getElementById('srs-review-btn'),
            topicReviewBtn: document.getElementById('topic-review-btn'),
            errorModal: document.getElementById('error-modal'),
            errorTitle: document.getElementById('error-title'),
            errorMessage: document.getElementById('error-message'),
            closeErrorModalBtn: document.getElementById('close-error-modal-btn'),
            progressMatrixModal: document.getElementById('progress-matrix-modal'),
            progressModalTitle: document.getElementById('progress-modal-title'),
            progressMatrixBtn: document.getElementById('progress-matrix-btn'),
            topicProgressBtn: document.getElementById('topic-progress-btn'),
            closeProgressMatrixBtn: document.getElementById('close-progress-matrix-btn'),
            progressGridContainer: document.getElementById('progress-grid-container'),
            shuffleBtn: document.getElementById('shuffle-btn'),
            backToLearnBtn: document.getElementById('back-to-learn-btn'),
            knownBtn: document.getElementById('known-btn'),
            toast: document.getElementById('toast-notification'),
            resetProgressBtn: document.getElementById('reset-progress-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmBtn: document.getElementById('confirm-btn'),
            cancelBtn: document.getElementById('cancel-btn'),
            statsUnstudiedCount: document.getElementById('stats-unstudied-count'),
            statsUnstudiedPercent: document.getElementById('stats-unstudied-percent'),
            statsHardCount: document.getElementById('stats-hard-count'),
            statsHardPercent: document.getElementById('stats-hard-percent'),
            statsGoodCount: document.getElementById('stats-good-count'),
            statsGoodPercent: document.getElementById('stats-good-percent'),
            statsEasyCount: document.getElementById('stats-easy-count'),
            statsEasyPercent: document.getElementById('stats-easy-percent'),
            statsKnownCount: document.getElementById('stats-known-count'),
            statsKnownPercent: document.getElementById('stats-known-percent'),
            openTopicModalBtn: document.getElementById('open-topic-modal-btn'),
            currentTopicDisplay: document.getElementById('current-topic-display'),
            topicSelectModal: document.getElementById('topic-select-modal'),
            closeTopicModalBtn: document.getElementById('close-topic-modal-btn'),
            topicSearchInput: document.getElementById('topic-search-input'),
            topicListContainer: document.getElementById('topic-list-container'),
        };
        
        const speakerIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>`;
        const loadingIconSVG = `<div class="loader"></div>`;

        // --- CORE FUNCTIONS ---
        function findWordData(wordKey) {
            return vocabularyMap.get(wordKey);
        }

        // --- SRS (Spaced Repetition System) LOGIC ---
        function updateSrsProgress(wordKey, rating) {
            let progress = srsProgressData[wordKey] || { level: 1 };
            let currentLevel = progress.level;

            if (rating === 'hard') {
                currentLevel = 1;
            } else if (rating === 'good') {
                 currentLevel = Math.min(MAX_SRS_LEVEL, currentLevel + 1);
            } else if (rating === 'easy') {
                currentLevel = Math.min(MAX_SRS_LEVEL, currentLevel + 2);
            }

            const intervalDays = SRS_INTERVALS[currentLevel] || 1;
            const nextReviewDate = new Date();
            nextReviewDate.setDate(nextReviewDate.getDate() + intervalDays);
            
            srsProgressData[wordKey] = {
                level: currentLevel,
                nextReviewDate: nextReviewDate.toISOString()
            };
            saveSrsProgress();
        }

        function markAsKnown(wordKey) {
            const farFutureDate = new Date();
            farFutureDate.setFullYear(farFutureDate.getFullYear() + 10);
            srsProgressData[wordKey] = {
                level: 99,
                nextReviewDate: farFutureDate.toISOString()
            };
            saveSrsProgress();
            showToast(`'${wordKey}' ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† ƒë√£ bi·∫øt.`);
        }

        function getGlobalReviewQueue() {
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            let queue = [];
            for (const wordKey in srsProgressData) {
                const progress = srsProgressData[wordKey];
                if (new Date(progress.nextReviewDate) <= today && progress.level < 99) {
                    queue.push(wordKey);
                }
            }
            return queue;
        }

        function getTopicReviewQueue(categoryKey) {
            if (!categories[categoryKey]) return [];
            const topicWords = categories[categoryKey];
            return topicWords.filter(wordKey => srsProgressData.hasOwnProperty(wordKey) && srsProgressData[wordKey].level < 99);
        }


        // --- DATA PERSISTENCE (LocalStorage) ---
        function saveSrsProgress() {
            try {
                localStorage.setItem(SRS_PROGRESS_KEY, JSON.stringify(srsProgressData));
            } catch (e) {
                console.error("Failed to save SRS progress:", e);
                showErrorModal("Kh√¥ng th·ªÉ l∆∞u ti·∫øn tr√¨nh h·ªçc t·∫≠p.");
            }
        }

        function loadSrsProgress() {
            const savedData = localStorage.getItem(SRS_PROGRESS_KEY);
            if (savedData) {
                try {
                    srsProgressData = JSON.parse(savedData);
                } catch (e) {
                    srsProgressData = {};
                }
            }
        }

        function saveLastSession() {
            const sessionData = {
                mode: currentMode,
                category: currentCategoryKey,
                words: currentWords,
                index: currentIndex
            };
            localStorage.setItem(LAST_SESSION_KEY, JSON.stringify(sessionData));
        }

        function loadLastSession() {
            const savedSession = localStorage.getItem(LAST_SESSION_KEY);
            if (savedSession) {
                try {
                    return JSON.parse(savedSession);
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        function clearLastSession() {
             localStorage.removeItem(LAST_SESSION_KEY);
        }
        
        // --- UI RENDERING AND UPDATES ---
        function updateControlVisibility() {
            const hasMultipleWords = currentWords.length > 1;
            const isLearnMode = currentMode === MODES.LEARN;
            const isReviewMode = currentMode === MODES.TOPIC_REVIEW || currentMode === MODES.GLOBAL_REVIEW;
            const isGlobalReviewMode = currentMode === MODES.GLOBAL_REVIEW;

            ui.shuffleBtn.classList.toggle('hidden', !hasMultipleWords || !isLearnMode);
            ui.topicProgressBtn.classList.toggle('hidden', isGlobalReviewMode);
            ui.progressMatrixBtn.classList.remove('hidden');
            ui.backToLearnBtn.classList.toggle('hidden', !isReviewMode);

            const actionGroup = document.getElementById('action-buttons-group');
            const isAnyActionVisible = Array.from(actionGroup.children).some(child => !child.classList.contains('hidden'));
            actionGroup.classList.toggle('hidden', !isAnyActionVisible);
            actionGroup.classList.toggle('flex', isAnyActionVisible);

            const showNavButtons = hasMultipleWords;
            ui.cardPrevBtn.classList.toggle('hidden', !showNavButtons);
            ui.cardNextBtn.classList.toggle('hidden', !showNavButtons);

            updateReviewButtons();
        }


        function updateReviewButtons() {
            const globalQueue = getGlobalReviewQueue();
            ui.srsReviewBtn.querySelector('.font-bold').textContent = globalQueue.length;
            ui.srsReviewBtn.disabled = globalQueue.length === 0;

            const topicQueue = getTopicReviewQueue(currentCategoryKey);
            ui.topicReviewBtn.querySelector('.font-bold').textContent = topicQueue.length;
            ui.topicReviewBtn.disabled = topicQueue.length === 0;
            ui.topicReviewBtn.classList.toggle('hidden', currentMode !== MODES.LEARN);
            ui.topicReviewBtn.classList.toggle('flex', currentMode === MODES.LEARN);
        }
        
        function renderTopicsInModal(searchTerm = '') {
            ui.topicListContainer.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const sortedKeys = Object.keys(categories).sort();

            const filteredKeys = sortedKeys.filter(key => key.toLowerCase().includes(lowerCaseSearchTerm));

            if (filteredKeys.length === 0) {
                ui.topicListContainer.innerHTML = `<p class="text-slate-500 text-center py-4">Kh√¥ng t√¨m th·∫•y ch·ªß ƒë·ªÅ n√†o.</p>`;
                return;
            }

            filteredKeys.forEach((key) => {
                const count = categories[key].length;
                const item = document.createElement('button');
                item.className = 'topic-modal-item w-full p-3 text-left rounded-lg hover:bg-blue-50 hover:text-blue-700 flex justify-between items-center';
                item.dataset.categoryKey = key;
                
                const textSpan = document.createElement('span');
                textSpan.className = 'font-medium';
                textSpan.textContent = key;
                
                const countSpan = document.createElement('span');
                countSpan.className = 'text-sm bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full';
                countSpan.textContent = count;

                item.appendChild(textSpan);
                item.appendChild(countSpan);

                item.addEventListener('click', () => {
                    const selectedKey = item.dataset.categoryKey;
                    startSession(MODES.LEARN, selectedKey);
                    ui.topicSelectModal.classList.add('hidden');
                    unlockBodyScroll();
                });

                ui.topicListContainer.appendChild(item);
            });
        }

        function startSession(mode, categoryKey, customWordList = null) {
            currentMode = mode;
            currentCategoryKey = categoryKey;
            
            if (mode === MODES.LEARN) {
                const allWordsInCategory = categories[categoryKey] || [];
                currentWords = allWordsInCategory.filter(word => !srsProgressData.hasOwnProperty(word));
                currentIndex = 0;
            } else { 
                currentWords = customWordList || [];
                currentIndex = 0;
            }
            
            const count = categories[categoryKey] ? categories[categoryKey].length : 0;
            ui.currentTopicDisplay.textContent = `${categoryKey} (${count})`;
            
            updateControlVisibility();
            displayCard();
        }

        function displayCard() {
            if (ui.flashcard.classList.contains('is-flipped')) {
                ui.flashcard.classList.remove('is-flipped');
            }
            
            setTimeout(() => { 
                if (currentWords.length === 0 || currentIndex >= currentWords.length) {
                    ui.flashcardFront.innerHTML = '';
                    ui.cardBackContent.innerHTML = '';
                    ui.srsRatingGroup.classList.add('invisible', 'opacity-0');

                    let message;
                    if (currentMode === MODES.LEARN) {
                        const allWordsInTopic = categories[currentCategoryKey] || [];
                        const learnedWordsInTopicCount = allWordsInTopic.filter(word => srsProgressData.hasOwnProperty(word)).length;

                        if (allWordsInTopic.length > 0 && allWordsInTopic.length === learnedWordsInTopicCount) {
                            message = 'Ch·ªß ƒë·ªÅ n√†y ƒë√£ h·ªçc xong. Ch·ªçn "√în t·∫≠p theo ch·ªß ƒë·ªÅ" ho·∫∑c "Luy·ªán t·∫≠p ng√†y" ƒë·ªÉ √¥n l·∫°i.';
                        } else if (allWordsInTopic.length === 0) {
                            message = 'Ch·ªß ƒë·ªÅ n√†y ch∆∞a c√≥ t·ª´ n√†o.';
                        } else {
                            message = 'Ch√∫c m·ª´ng! B·∫°n ƒë√£ h·ªçc h·∫øt t·ª´ m·ªõi trong ch·ªß ƒë·ªÅ n√†y.';
                        }
                    } else { // Review modes
                        message = 'Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh phi√™n √¥n t·∫≠p.';
                    }

                    let contentHTML = `<div class="text-center p-4">
                        <p class="text-xl text-slate-500 mb-6">${message}</p>`;

                    if (currentMode !== MODES.LEARN) {
                        contentHTML += `<button id="review-again-btn" class="animated-button px-6 py-3 bg-blue-500 text-white rounded-xl flex items-center gap-2 mx-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                            √în t·∫≠p l·∫°i
                        </button>`;
                    }
                    contentHTML += `</div>`;
                    ui.flashcardFront.innerHTML = contentHTML;

                    const reviewAgainBtn = document.getElementById('review-again-btn');
                    if (reviewAgainBtn) {
                        reviewAgainBtn.addEventListener('click', () => {
                            let queue;
                            if(currentMode === MODES.GLOBAL_REVIEW) queue = getGlobalReviewQueue();
                            else queue = getTopicReviewQueue(currentCategoryKey);
                            startSession(currentMode, currentCategoryKey, queue);
                        });
                    }

                    updateNavigation();
                    updateControlVisibility();
                    return;
                }

                ui.srsRatingGroup.classList.remove('invisible', 'opacity-0');
                ui.cardBackContent.innerHTML = '';

                const wordKey = currentWords[currentIndex];
                const cardData = findWordData(wordKey);
                
                if (!cardData) { 
                    ui.flashcardFront.innerHTML = `<p class="text-xl text-red-500">L·ªói: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu t·ª´.</p>`; 
                    updateNavigation();
                    return; 
                }

                const partsOfSpeech = [...new Set(cardData.meanings.map(m => m.type))].join(', ');
                const phoneticText = cardData.phonetic ? `/${cardData.phonetic.replace(/\//g, '')}/` : '';
                
                ui.flashcardFront.innerHTML = `
                    <div id="card-front-content" class="text-center p-4">
                         <div class="flex items-center justify-center gap-3">
                            <h2 class="text-4xl md:text-5xl font-bold break-words text-slate-800">${wordKey}</h2>
                            <button id="front-audio-btn" class="play-audio-btn text-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                            </button>
                        </div>
                        <p class="text-xl italic text-slate-500 mt-2">(${partsOfSpeech}) ${phoneticText}</p>
                    </div>`;
                
                document.getElementById('front-audio-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    playAudio(wordKey, e.currentTarget);
                });
                
                const backContentWrapper = document.createElement('div');
                backContentWrapper.className = 'p-4 w-full';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex flex-col items-start gap-2 mb-4';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'flex items-baseline gap-2';
                
                const wordTitle = document.createElement('h3');
                wordTitle.className = 'text-3xl font-bold text-sky-800';
                wordTitle.textContent = wordKey;
                
                titleDiv.append(wordTitle);

                const mainAudioBtn = document.createElement('button');
                mainAudioBtn.className = 'play-audio-btn text-xl';
                mainAudioBtn.dataset.textToSpeak = wordKey;
                mainAudioBtn.title = 'Ph√°t √¢m';
                mainAudioBtn.innerHTML = speakerIconSVG;
                mainAudioBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    playAudio(e.currentTarget.dataset.textToSpeak, e.currentTarget);
                });

                headerDiv.append(titleDiv, mainAudioBtn);
                backContentWrapper.appendChild(headerDiv);

                cardData.meanings.forEach((meaningData) => {
                    const meaningBlock = document.createElement('div');
                    meaningBlock.className = 'mb-5 p-4 bg-white rounded-xl border';

                    const meaningHeader = document.createElement('div');
                    meaningHeader.className = 'flex items-center gap-3 mb-3';
                    
                    const typeBadge = document.createElement('span');
                    typeBadge.className = 'text-xs font-semibold uppercase text-sky-600 bg-sky-100 px-2 py-1 rounded-full';
                    typeBadge.textContent = meaningData.type;

                    const meaningText = document.createElement('p');
                    meaningText.className = 'text-lg font-semibold text-slate-800';
                    meaningText.textContent = meaningData.meaning;

                    meaningHeader.append(typeBadge, meaningText);
                    meaningBlock.appendChild(meaningHeader);
                    
                    if (meaningData.explanation) {
                        const explanationDiv = document.createElement('div');
                        explanationDiv.className = 'mt-2 mb-3 p-3 bg-gray-50 rounded-lg';
                        const explanationText = document.createElement('p');
                        explanationText.className = 'text-base text-slate-600 italic';
                        explanationText.textContent = `üí° ${meaningData.explanation}`;
                        explanationDiv.appendChild(explanationText);
                        meaningBlock.appendChild(explanationDiv);
                    }

                    const exampleList = document.createElement('ul');
                    exampleList.className = 'space-y-3 list-inside';

                    meaningData.examples.forEach((ex) => {
                        const listItem = document.createElement('li');
                        listItem.className = 'text-base';
                        
                        const englishLine = document.createElement('p');
                        englishLine.className = 'text-slate-700';
                        
                        // THAY ƒê·ªîI: In ƒë·∫≠m t·ª´ v·ª±ng trong v√≠ d·ª•
                        const regex = new RegExp(`\\b(${wordKey})\\b`, 'gi');
                        const highlightedHTML = ex.en.replace(regex, `<strong class="text-blue-600 font-bold">$1</strong>`);
                        englishLine.innerHTML = `‚Äú${highlightedHTML}‚Äù `;

                        const exampleAudioBtn = document.createElement('button');
                        exampleAudioBtn.className = 'play-audio-btn';
                        exampleAudioBtn.dataset.textToSpeak = ex.en;
                        exampleAudioBtn.title = 'Ph√°t √¢m v√≠ d·ª•';
                        exampleAudioBtn.innerHTML = speakerIconSVG;
                        exampleAudioBtn.addEventListener('click', (e) => {
                           e.stopPropagation();
                           playAudio(e.currentTarget.dataset.textToSpeak, e.currentTarget);
                        });

                        englishLine.appendChild(exampleAudioBtn);

                        const vietnameseLine = document.createElement('p');
                        vietnameseLine.className = 'text-sm text-slate-500 italic ml-4';
                        vietnameseLine.textContent = `‚Üí ${ex.vi}`;

                        listItem.append(englishLine, vietnameseLine);
                        exampleList.appendChild(listItem);
                    });
                    
                    if (meaningData.examples.length > 0) {
                        meaningBlock.appendChild(exampleList);
                    }
                    backContentWrapper.appendChild(meaningBlock);
                });

                ui.cardBackContent.appendChild(backContentWrapper);
                updateNavigation();
                updateControlVisibility();
                
                if (userHasInteracted) {
                    playAudio(wordKey, null);
                }
            }, 150);
        }

        function showCardCounter() {
            if (counterTimeout) {
                clearTimeout(counterTimeout);
            }
            ui.cardCounter.classList.add('visible');
            counterTimeout = setTimeout(() => {
                ui.cardCounter.classList.remove('visible');
            }, 1200);
        }

        function updateNavigation() {
            const hasWords = currentWords.length > 0;
            const totalInQueue = currentWords.length;
            const currentPosition = totalInQueue > 0 ? currentIndex + 1 : 0;
            ui.cardCounter.textContent = `${currentPosition}/${totalInQueue}`;
        }

        function updateProgressMatrixAndStats(categoryKey = null) {
            ui.progressGridContainer.innerHTML = '';
            
            let wordsToShow = [];
            let title = "Th·ªëng k√™ t·ªïng qu√°t";

            if (categoryKey && categories[categoryKey]) {
                title = `Th·ªëng k√™ ch·ªß ƒë·ªÅ: ${categoryKey}`;
                wordsToShow = categories[categoryKey];
            } else {
                wordsToShow = Array.from(vocabularyMap.keys());
            }
            
            ui.progressModalTitle.textContent = title;
            const counts = { unstudied: 0, hard: 0, good: 0, easy: 0, known: 0 };
            const totalWords = wordsToShow.length;

            wordsToShow.sort().forEach(wordKey => {
                const dot = document.createElement('div');
                let dotColorClass = 'bg-slate-300';
                let dotTitle = `${wordKey}`;
                const wordData = findWordData(wordKey);

                if (srsProgressData.hasOwnProperty(wordKey)) {
                    const progress = srsProgressData[wordKey];
                    const level = progress.level;
                    dotTitle += ` - Level: ${level}`;

                    if (level >= 99) {
                        dotColorClass = 'bg-purple-500';
                        counts.known++;
                    } else if (level <= 2) {
                        dotColorClass = 'bg-red-500';
                        counts.hard++;
                    } else if (level <= 4) {
                        dotColorClass = 'bg-blue-500';
                        counts.good++;
                    } else {
                        dotColorClass = 'bg-green-500';
                        counts.easy++;
                    }
                } else {
                    counts.unstudied++;
                }
                
                dot.className = `progress-dot w-4 h-4 rounded-sm ${dotColorClass}`;
                dot.title = dotTitle;
                dot.dataset.wordKey = wordKey;
                dot.dataset.category = wordData.category;

                dot.addEventListener('click', () => {
                    const wordCategory = dot.dataset.category;
                    const clickedWordKey = dot.dataset.wordKey;
                    
                    startSession(MODES.TOPIC_REVIEW, wordCategory, [clickedWordKey]);
                    ui.progressMatrixModal.classList.add('hidden');
                    unlockBodyScroll();
                });

                ui.progressGridContainer.appendChild(dot);
            });

            const calcPercent = (count) => totalWords > 0 ? ((count / totalWords) * 100).toFixed(0) : 0;
            ui.statsUnstudiedCount.textContent = counts.unstudied;
            ui.statsUnstudiedPercent.textContent = `${calcPercent(counts.unstudied)}%`;
            ui.statsHardCount.textContent = counts.hard;
            ui.statsHardPercent.textContent = `${calcPercent(counts.hard)}%`;
            ui.statsGoodCount.textContent = counts.good;
            ui.statsGoodPercent.textContent = `${calcPercent(counts.good)}%`;
            ui.statsEasyCount.textContent = counts.easy;
            ui.statsEasyPercent.textContent = `${calcPercent(counts.easy)}%`;
            ui.statsKnownCount.textContent = counts.known;
            ui.statsKnownPercent.textContent = `${calcPercent(counts.known)}%`;
        }
        
        function playAudio(text, buttonEl) {
            if (!text || !speechSynth) return;
            if (speechSynth.speaking) {
                speechSynth.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';

            const preferredVoices = ['Siri', 'Samantha', 'Google US English', 'Alex', 'Daniel'];
            let selectedVoice = null;

            for (const voiceName of preferredVoices) {
                selectedVoice = availableVoices.find(voice => voice.name.includes(voiceName) && voice.lang.startsWith('en-'));
                if (selectedVoice) break;
            }

            if (!selectedVoice) {
                selectedVoice = availableVoices.find(voice => voice.lang.startsWith('en-US') && voice.localService);
            }
            if (!selectedVoice) {
                selectedVoice = availableVoices.find(voice => voice.lang.startsWith('en-US'));
            }
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }

            let originalContent = null;
            if (buttonEl) {
                if(buttonEl.disabled) return;
                originalContent = buttonEl.innerHTML;
                buttonEl.innerHTML = loadingIconSVG;
                buttonEl.disabled = true;
            }

            const cleanup = () => {
                if (buttonEl) {
                    buttonEl.innerHTML = originalContent;
                    buttonEl.disabled = false;
                }
            };

            utterance.onend = cleanup;
            utterance.onerror = (e) => {
                if (e.error === 'interrupted' || e.error === 'canceled') {
                    cleanup();
                    return;
                }
                console.error("SpeechSynthesis Error:", e);
                showToast(`L·ªói ph√°t √¢m: ${e.error}`);
                cleanup();
            };

            speechSynth.speak( utterance );
        }

        // --- EVENT HANDLERS & USER ACTIONS ---
        function handleSrsAnswer(rating) {
            if (currentWords.length === 0) return;
            
            const wordKey = currentWords[currentIndex];
            updateSrsProgress(wordKey, rating);
            
            currentWords.splice(currentIndex, 1);

            if (currentIndex >= currentWords.length && currentWords.length > 0) {
                currentIndex = currentWords.length - 1;
            }
            
            displayCard();
            updateNavigation();
            updateReviewButtons();
        }

        function handleKnownAnswer() {
            if (currentWords.length === 0) return;
            const wordKey = currentWords[currentIndex];
            markAsKnown(wordKey);
            
            currentWords.splice(currentIndex, 1);

            if (currentIndex >= currentWords.length && currentWords.length > 0) {
                currentIndex = currentWords.length - 1;
            }

            displayCard();
            updateNavigation();
            updateReviewButtons();
        }
        
        function navigate(direction) {
            if (currentWords.length > 1) {
                let newIndex = currentIndex + direction;
                if (newIndex >= currentWords.length) {
                    newIndex = 0;
                }
                if (newIndex < 0) {
                    newIndex = currentWords.length - 1;
                }
                currentIndex = newIndex;

                displayCard();
                showCardCounter();
            }
        }

        function shuffleCurrentQueue() {
            if (currentWords.length < 2) return;
            for (let i = currentWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentWords[i], currentWords[j]] = [currentWords[j], currentWords[i]];
            }
            currentIndex = 0;
            displayCard();
            showToast("ƒê√£ x√°o tr·ªôn danh s√°ch t·ª´!");
        }

        function resetAllProgress() {
            showConfirmModal(
                "X√°c nh·∫≠n x√≥a ti·∫øn tr√¨nh",
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô ti·∫øn tr√¨nh h·ªçc t·∫≠p kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.",
                () => {
                    srsProgressData = {};
                    localStorage.removeItem(SRS_PROGRESS_KEY);
                    clearLastSession();
                    
                    updateProgressMatrixAndStats(lastProgressViewCategory);
                    updateReviewButtons();
                    showToast("ƒê√£ x√≥a to√†n b·ªô ti·∫øn tr√¨nh h·ªçc t·∫≠p.");
                    
                    startSession(MODES.LEARN, currentCategoryKey);
                }
            );
        }

        function showToast(message) {
            ui.toast.textContent = message;
            ui.toast.classList.add('show');
            setTimeout(() => {
                ui.toast.classList.remove('show');
            }, 2000);
        }

        function showErrorModal(message, title = "ƒê√£ x·∫£y ra l·ªói") { 
            ui.errorTitle.textContent = title;
            ui.errorMessage.textContent = message; 
            ui.errorModal.classList.remove("hidden"); 
            lockBodyScroll();
        }

        function showConfirmModal(title, message, onConfirm) {
            ui.confirmTitle.textContent = title;
            ui.confirmMessage.textContent = message;
            ui.confirmModal.classList.remove('hidden');
            lockBodyScroll();

            const confirmHandler = () => {
                onConfirm();
                closeAndCleanup();
            };

            const cancelHandler = () => {
                closeAndCleanup();
            };
            
            const closeAndCleanup = () => {
                ui.confirmModal.classList.add('hidden');
                unlockBodyScroll();
                ui.confirmBtn.removeEventListener('click', confirmHandler);
                ui.cancelBtn.removeEventListener('click', cancelHandler);
            };

            ui.confirmBtn.addEventListener('click', confirmHandler);
            ui.cancelBtn.addEventListener('click', cancelHandler);
        }

        function lockBodyScroll() {
            document.body.classList.add('modal-open');
        }

        function unlockBodyScroll() {
            document.body.classList.remove('modal-open');
        }
        
        async function loadVocabularyData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`L·ªói HTTP! Tr·∫°ng th√°i: ${response.status}`);
                }
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    vocabularyList = data;
                    vocabularyList.forEach(wordData => {
                        vocabularyMap.set(wordData.word, wordData);
                        
                        const category = wordData.category;
                        if (!categories[category]) {
                            categories[category] = [];
                        }
                        categories[category].push(wordData.word);
                    });
                    return true;
                } else {
                    throw new Error("ƒê·ªãnh d·∫°ng JSON kh√¥ng ph·∫£i l√† m·ªôt m·∫£ng (Array).");
                }

            } catch (error) {
                console.error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ v·ª±ng:', error);
                ui.flashcardFront.innerHTML = `<div class="text-center p-4">
                    <h2 class="text-2xl font-bold text-red-600 mb-2">L·ªói T·∫£i D·ªØ Li·ªáu</h2>
                    <p class="text-slate-600">Kh√¥ng th·ªÉ t·∫£i t·ªáp t·ª´ v·ª±ng. Vui l√≤ng ƒë·∫£m b·∫£o t·ªáp <strong>${url}</strong> t·ªìn t·∫°i v√† c√≥ ƒë·ªãnh d·∫°ng JSON ch√≠nh x√°c.</p>
                    <p class="text-xs text-slate-400 mt-4">Chi ti·∫øt l·ªói: ${error.message}</p>
                </div>`;
                return null;
            }
        }

        // --- INITIALIZATION ---
        function initializeApp() {
            loadSrsProgress();
            
            const firstCategory = Object.keys(categories)[0] || null;
            currentCategoryKey = firstCategory;

            renderTopicsInModal();
            
            document.addEventListener('keydown', (e) => {
                if (['ArrowUp', 'ArrowDown', ' '].includes(e.key)) {
                    e.preventDefault();
                    ui.flashcard.click();
                }
                if (e.key === 'ArrowLeft') {
                    navigate(-1);
                } else if (e.key === 'ArrowRight') {
                    navigate(1);
                }
            });
            
            ui.cardPrevBtn.addEventListener('click', (e) => { e.stopPropagation(); navigate(-1); });
            ui.cardNextBtn.addEventListener('click', (e) => { e.stopPropagation(); navigate(1); });

            ui.flashcard.addEventListener('click', (e) => {
                if (e.target.closest('.play-audio-btn, #review-again-btn, .card-nav-btn, .srs-icon-btn, #front-audio-btn')) {
                    return;
                }
                if (currentWords.length > 0 && currentIndex < currentWords.length) {
                    ui.flashcard.classList.toggle('is-flipped');
                }
            });

            ui.srsReviewBtn.addEventListener('click', () => {
                let reviewQueue = getGlobalReviewQueue();
                if (reviewQueue.length > 0) {
                    startSession(MODES.GLOBAL_REVIEW, "GLOBAL_REVIEW_MODE", reviewQueue);
                }
            });

            ui.topicReviewBtn.addEventListener('click', () => {
                let reviewQueue = getTopicReviewQueue(currentCategoryKey);
                if (reviewQueue.length > 0) {
                    startSession(MODES.TOPIC_REVIEW, currentCategoryKey, reviewQueue);
                }
            });
            
            ui.backToLearnBtn.addEventListener('click', () => {
                startSession(MODES.LEARN, currentCategoryKey);
            });

            ui.closeErrorModalBtn.addEventListener('click', () => {
                ui.errorModal.classList.add('hidden');
                unlockBodyScroll();
            });
            
            ui.progressMatrixBtn.addEventListener('click', () => {
                lastProgressViewCategory = null;
                updateProgressMatrixAndStats();
                ui.progressMatrixModal.classList.remove('hidden');
                lockBodyScroll();
            });
            ui.topicProgressBtn.addEventListener('click', () => {
                lastProgressViewCategory = currentCategoryKey;
                updateProgressMatrixAndStats(currentCategoryKey);
                ui.progressMatrixModal.classList.remove('hidden');
                lockBodyScroll();
            });
            ui.closeProgressMatrixBtn.addEventListener('click', () => {
                ui.progressMatrixModal.classList.add('hidden');
                unlockBodyScroll();
            });
            ui.progressMatrixModal.addEventListener('click', (e) => {
                if (e.target === ui.progressMatrixModal) {
                    ui.progressMatrixModal.classList.add('hidden');
                    unlockBodyScroll();
                }
            });

            ui.shuffleBtn.addEventListener('click', shuffleCurrentQueue);
            ui.resetProgressBtn.addEventListener('click', resetAllProgress);

            ui.srsRatingGroup.addEventListener('click', (e) => {
                const button = e.target.closest('.srs-icon-btn');
                if (!button) return;
                
                e.stopPropagation();

                if (button.classList.contains('srs-rating-btn')) {
                    handleSrsAnswer(button.dataset.rating);
                } else if (button.id === 'known-btn') {
                    handleKnownAnswer();
                }
            });
            
            ui.openTopicModalBtn.addEventListener('click', () => {
                ui.topicSelectModal.classList.remove('hidden');
                lockBodyScroll();
                ui.topicSearchInput.focus();
            });

            ui.closeTopicModalBtn.addEventListener('click', () => {
                ui.topicSelectModal.classList.add('hidden');
                unlockBodyScroll();
            });

            ui.topicSelectModal.addEventListener('click', (e) => {
                if (e.target === ui.topicSelectModal) {
                    ui.topicSelectModal.classList.add('hidden');
                    unlockBodyScroll();
                }
            });

            ui.topicSearchInput.addEventListener('input', (e) => {
                renderTopicsInModal(e.target.value);
            });


            if (firstCategory) {
                startSession(MODES.LEARN, firstCategory);
            } else {
                 ui.flashcardFront.innerHTML = `<p class="text-xl text-slate-500">Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ v·ª±ng n√†o.</p>`;
                 updateControlVisibility();
            }
        }
        
        async function startApp() {
            const dataUrl = 'vocabulary.json';
            const success = await loadVocabularyData(dataUrl);

            if (success) {
                try {
                    initializeApp();
                } catch (error) {
                    console.error('Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng v·ªõi d·ªØ li·ªáu:', error);
                    showErrorModal(`${error.message}.`, "L·ªói kh·ªüi t·∫°o d·ªØ li·ªáu");
                }
            }
        }
        
        function loadVoices() {
            if (voicesLoaded) return;
            try {
                availableVoices = speechSynthesis.getVoices();
                if (availableVoices.length > 0) {
                    voicesLoaded = true;
                }
            } catch (e) {
                console.error("Could not load voices:", e);
            }
        }

        function handleFirstInteraction() {
            userHasInteracted = true;
            if (currentWords.length > 0 && currentIndex < currentWords.length) {
                playAudio(currentWords[currentIndex], null);
            }
        }

        // --- APP START ---
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('click', handleFirstInteraction, { once: true });
            document.addEventListener('keydown', handleFirstInteraction, { once: true });

            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            startApp();
        });
    </script>
</body>
</html>
